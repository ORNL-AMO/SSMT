<?php
/**
 * Steam Calculators
 * 
 * @package    Steam
 * @subpackage Steam_Download
 * @version    beta
 * @author     Michael B Muller
 * <mbm@analyticalenergy.com>
 */

/**
 * Generates Excel Spreadsheet of Steam and Saturated Properties
 * @package    Steam
 * @subpackage Steam_Download
 */
class Steam_Download_SteamProperties{
    
    /**
     * PHPExcel Object
     * @var PHPExcel
     */
    var $objPHPExcel;
    
    /**
     * Steam MeasurementSystem Object
     * @var Steam_MeasurementSystem
     */
    var $mS;
    /**
     * Zend_Translate
     * @var Zend_Translate
     */
    public $translator;
    
    /**
     * Generates a PHPExcel Based Excel Spreadsheet of Steam and Saturated Properties     
     * @param array() $steamProperties
     * @param array() $saturatedProperties 
     */
    public function __construct($steamProperties, $saturatedProperties) {   
        if (!is_array($steamProperties)) $steamProperties = array();
        if (!is_array($saturatedProperties)) $saturatedProperties = array();
        $steamPropertyList = new Zend_Session_Namespace('steamPropertyList');    
                
        $this->mS = new Steam_MeasurementSystem();
        $this->translator = Zend_Registry::get('Zend_Translate');
        
        require_once APPLICATION_PATH.'/../library/PhpExcel/PHPExcel.php';

        // Create new PHPExcel object
        $this->objPHPExcel = new PHPExcel();

        // Set properties
        $this->objPHPExcel->getProperties()->setCreator("DOE-AMO Steam Calculators")
                                    ->setLastModifiedBy("DOE-AMO Steam Calculators")
                                    ->setTitle("Steam Properties")
                                    ->setSubject("Steam Properties")
                                    ->setDescription("List of Steam Properties")
                                    ->setKeywords("steam properties calculator")
                                    ->setCategory("Steam");
        
        $this->addCoverPage();
        $this->addSteamPropPage($steamProperties);
        $this->addSaturatedPropPage($saturatedProperties);        
        
        $this->objPHPExcel->setActiveSheetIndex(0);
        
        //Export file
        header('Content-Type: application/vnd.ms-excel');
        header('Content-Disposition: attachment;filename=SteamPropertiesList.xls');
        header('Cache-Control: max-age=0');

        $objWriter = PHPExcel_IOFactory::createWriter($this->objPHPExcel, 'Excel5');
        $objWriter->save('php://output');
    }
    
    /**
     * Add Cover Page
     */
    private function addCoverPage(){
        $mS = $this->mS;
        $activeSheet = $this->objPHPExcel->setActiveSheetIndex(0);
        $activeSheet->setTitle($this->translator->_('Overview'));

        $activeSheet->setCellValue('B2',$this->translator->_('[Demo] Steam Calculators'));
        $activeSheet->setCellValue('B3',$this->translator->_('Steam Properties'));
        $activeSheet->setCellValue('B4',$this->translator->_('link to website'));

        $activeSheet->setCellValue('B6',$this->translator->_('Generated by the:'));
        $activeSheet->setCellValue('B7',$this->translator->_('Deparment of Energy:'));
        $activeSheet->setCellValue('B8',$this->translator->_('Advanced Manufacturing Office'));
        $activeSheet->setCellValue('B9',$this->translator->_('Steam Property Calculators'));  
        $activeSheet->setCellValue('B10',date('m-d-Y'));            

        $activeSheet->getColumnDimension('A')->setWidth(2);
        $activeSheet->getColumnDimension('B')->setWidth(60);

        $activeSheet->getStyle('B2:B2')->getFont() 
                ->getColor()->setARGB('FF1F497D');            
        $activeSheet->getCell('B4')->getHyperlink()->setUrl('http://'.$_SERVER['HTTP_HOST'].'/');
        $activeSheet->getStyle('B3:B3')->getFont()
                ->setBold('true')
                ->setSize(24)
                ->getColor()->setARGB('FF1F497D');
        $activeSheet->getStyle('B4:B4')->getFont()
                ->setBold('true')
                ->setUnderline(PHPExcel_Style_Font::UNDERLINE_SINGLE)
                ->getColor()->setARGB(PHPExcel_Style_Color::COLOR_DARKBLUE);                  
        $activeSheet->getStyle('B6:B6')->getFont()
                ->setSize(9)
                ->setItalic(true)
                ->getColor()->setARGB('FF555555');            
        $activeSheet->getStyle('B9:B9')->getFont()
                ->setBold('true');
        
        $activeSheet->getStyle('A100:A100');
    }
    
    /**
     * Add Steam Properties Page
     */
    private function addSteamPropPage($steamProperties){
        $mS = $this->mS;
        $objWorkSheet = $this->objPHPExcel->createSheet();
        $objWorkSheet->setTitle($this->translator->_('Steam Properties'));
        
        $linePointer = 1;
        
        $objWorkSheet->setCellValue('A1',$this->translator->_('Pressure'));
        $objWorkSheet->setCellValue('B1',$this->translator->_('Temperature'));
        $objWorkSheet->setCellValue('C1',$this->translator->_('Specific Enthalpy'));
        $objWorkSheet->setCellValue('D1',$this->translator->_('Specific Entropy'));
        $objWorkSheet->setCellValue('E1',$this->translator->_('Phase / Quality'));
        $objWorkSheet->setCellValue('F1',$this->translator->_('Specific Volume'));
        $objWorkSheet->setCellValue('G1',$this->translator->_('Density'));
        $objWorkSheet->setCellValue('A2',$mS->excelUnits('pressure'));
        $objWorkSheet->setCellValue('B2',$mS->excelUnits('temperature'));
        $objWorkSheet->setCellValue('C2',$mS->excelUnits('specificEnthalpy'));
        $objWorkSheet->setCellValue('D2',$mS->excelUnits('specificEntropy'));
        $objWorkSheet->setCellValue('F2',$mS->excelUnits('specificVolume'));
        $objWorkSheet->setCellValue('G2',$mS->excelUnits('density'));
        
        $objWorkSheet->getStyle('A1:G1')->getFont()
                ->setBold('true');
        $objWorkSheet->getStyle('A2:G2')->getFont()
                ->setBold('true')
                ->getColor()->setARGB('FFAAAAAA');
        $objWorkSheet->getStyle('A1:G2')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);

        $objWorkSheet->getStyle('A3:G30')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);

        $objWorkSheet->getStyle('A1:G1')->getFill()
            ->setFillType(PHPExcel_Style_Fill::FILL_SOLID)
            ->getStartColor()->setARGB('FFDDEEDD');

        $linePointer = 3;      
        $sectionLineStart = $linePointer;
        foreach($steamProperties as $key => $values){  
            $objWorkSheet->setCellValue('A'.$linePointer,$mS->localize($values->pressure,'pressure'));
            $objWorkSheet->setCellValue('B'.$linePointer,$mS->localize($values->temperature,'temperature'));
            $objWorkSheet->setCellValue('C'.$linePointer,$mS->localize($values->specificEnthalpy,'specificEnthalpy'));
            $objWorkSheet->setCellValue('D'.$linePointer,$mS->localize($values->specificEntropy,'specificEntropy'));          
            if (!is_null($values->quality)){
                $objWorkSheet->setCellValue('E'.$linePointer,$values->quality);
            }else{
                $objWorkSheet->setCellValue('E'.$linePointer,$values->phase);
            }            
            $objWorkSheet->setCellValue('F'.$linePointer,$mS->localize($values->specificVolume,'specificVolume'));             
            $objWorkSheet->setCellValue('G'.$linePointer,$mS->localize($values->density,'density'));
            $linePointer++;
        }
        $objWorkSheet->getStyle('A'.$sectionLineStart.':A'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('pressure'));
        $objWorkSheet->getStyle('B'.$sectionLineStart.':B'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('temperature'));
        $objWorkSheet->getStyle('C'.$sectionLineStart.':C'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('specificEnthalpy'));
        $objWorkSheet->getStyle('D'.$sectionLineStart.':D'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('specificEntropy'));
        $objWorkSheet->getStyle('E'.$sectionLineStart.':E'.$linePointer)->getNumberFormat()->setFormatCode('#,##0.00');
        $objWorkSheet->getStyle('F'.$sectionLineStart.':F'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('specificVolume'));
        $objWorkSheet->getStyle('G'.$sectionLineStart.':G'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('density'));

        $objWorkSheet->getColumnDimension('A')->setWidth(10);
        $objWorkSheet->getColumnDimension('B')->setWidth(14);
        $objWorkSheet->getColumnDimension('C')->setWidth(16);
        $objWorkSheet->getColumnDimension('D')->setWidth(16);
        $objWorkSheet->getColumnDimension('E')->setWidth(16);
        $objWorkSheet->getColumnDimension('F')->setWidth(16);
        $objWorkSheet->getColumnDimension('G')->setWidth(10);                
        
        $objWorkSheet->getStyle('A100:A100');
    }
   
    /**
     * Add Saturated Properties Page
     */
    private function addSaturatedPropPage($saturatedProperties){    
        $mS = $this->mS;
        $objWorkSheet = $this->objPHPExcel->createSheet();
        $objWorkSheet->setTitle($this->translator->_('Saturated Properties'));
        
        $objWorkSheet->setCellValue('A2',$this->translator->_('Pressure'));
        $objWorkSheet->setCellValue('B2',$this->translator->_('Temperature'));
        $objWorkSheet->setCellValue('C1',$this->translator->_('Specific Enthalpy'));
        $objWorkSheet->setCellValue('C2',$this->translator->_('Sat. Liquid'));
        $objWorkSheet->setCellValue('D2',$this->translator->_('difference'));
        $objWorkSheet->setCellValue('E2',$this->translator->_('Sat. Gas'));
        $objWorkSheet->setCellValue('F1',$this->translator->_('Specific Entropy'));
        $objWorkSheet->setCellValue('F2',$this->translator->_('Sat. Liquid'));
        $objWorkSheet->setCellValue('G2',$this->translator->_('difference'));
        $objWorkSheet->setCellValue('H2',$this->translator->_('Sat. Gas'));
        $objWorkSheet->setCellValue('I1',$this->translator->_('Specific Volume'));
        $objWorkSheet->setCellValue('I2',$this->translator->_('Sat. Liquid'));
        $objWorkSheet->setCellValue('J2',$this->translator->_('difference'));
        $objWorkSheet->setCellValue('K2',$this->translator->_('Sat. Gas'));
            
        $objWorkSheet->mergeCells('C1:E1');
        $objWorkSheet->mergeCells('F1:H1');
        $objWorkSheet->mergeCells('I1:K1');
        $objWorkSheet->getStyle('A1:K30')->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);

        $objWorkSheet->getStyle('A1:K2')->getFill()
            ->setFillType(PHPExcel_Style_Fill::FILL_SOLID)
            ->getStartColor()->setARGB('FFDDEEDD');
        $objWorkSheet->getStyle('A1:K2')->getFont()
            ->setBold('true');
        $objWorkSheet->getStyle('A3:K3')->getFont()
            ->setBold('true')
            ->getColor()->setARGB('FFAAAAAA');
                        
        $objWorkSheet->getColumnDimension('A')->setWidth(10);
        $objWorkSheet->getColumnDimension('B')->setWidth(14);
        $objWorkSheet->getColumnDimension('C')->setWidth(12);
        $objWorkSheet->getColumnDimension('D')->setWidth(12);
        $objWorkSheet->getColumnDimension('E')->setWidth(12);
        $objWorkSheet->getColumnDimension('F')->setWidth(12);
        $objWorkSheet->getColumnDimension('G')->setWidth(12);
        $objWorkSheet->getColumnDimension('H')->setWidth(12);
        $objWorkSheet->getColumnDimension('I')->setWidth(12);
        $objWorkSheet->getColumnDimension('J')->setWidth(12);
        $objWorkSheet->getColumnDimension('K')->setWidth(12);

        $objWorkSheet->setCellValue('A3',$mS->excelUnits('pressure'));
        $objWorkSheet->setCellValue('B3',$mS->excelUnits('temperature'));
        $objWorkSheet->setCellValue('C3',$mS->excelUnits('specificEnthalpy'));
        $objWorkSheet->setCellValue('D3',$mS->excelUnits('specificEnthalpy'));
        $objWorkSheet->setCellValue('E3',$mS->excelUnits('specificEnthalpy'));
        $objWorkSheet->setCellValue('F3',$mS->excelUnits('specificEntropy'));
        $objWorkSheet->setCellValue('G3',$mS->excelUnits('specificEntropy'));
        $objWorkSheet->setCellValue('H3',$mS->excelUnits('specificEntropy'));
        $objWorkSheet->setCellValue('I3',$mS->excelUnits('specificVolume'));
        $objWorkSheet->setCellValue('J3',$mS->excelUnits('specificVolume'));
        $objWorkSheet->setCellValue('K3',$mS->excelUnits('specificVolume'));
                                
        $linePointer = 4;
        $sectionLineStart = $linePointer;
        foreach( $saturatedProperties as $key => $values){  
            $objWorkSheet->setCellValue('A'.$linePointer,$mS->localize($values['pressure'],'pressure'));
            $objWorkSheet->setCellValue('B'.$linePointer,$mS->localize($values['temperature'],'temperature'));
            
            $objWorkSheet->setCellValue('C'.$linePointer,$mS->localize($values['liquid']['specificEnthalpy'],'specificEnthalpy'));
            $objWorkSheet->setCellValue('D'.$linePointer,$mS->localize($values['gas']['specificEnthalpy']-$values['liquid']['specificEnthalpy'],'specificEnthalpy'));
            $objWorkSheet->setCellValue('E'.$linePointer,$mS->localize($values['gas']['specificEnthalpy'],'specificEnthalpy'));
            
            $objWorkSheet->setCellValue('F'.$linePointer,$mS->localize($values['liquid']['specificEntropy'],'specificEntropy'));
            $objWorkSheet->setCellValue('G'.$linePointer,$mS->localize($values['gas']['specificEntropy']-$values['liquid']['specificEntropy'],'specificEntropy'));
            $objWorkSheet->setCellValue('H'.$linePointer,$mS->localize($values['gas']['specificEntropy'],'specificEntropy'));
            
            $objWorkSheet->setCellValue('I'.$linePointer,$mS->localize($values['liquid']['specificVolume'],'specificVolume'));
            $objWorkSheet->setCellValue('J'.$linePointer,$mS->localize($values['gas']['specificVolume']-$values['liquid']['specificVolume'],'specificVolume'));
            $objWorkSheet->setCellValue('K'.$linePointer,$mS->localize($values['gas']['specificVolume'],'specificVolume'));
            $linePointer++;
        }
        $objWorkSheet->getStyle('A'.$sectionLineStart.':A'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('pressure'));
        $objWorkSheet->getStyle('B'.$sectionLineStart.':B'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('temperature'));
        $objWorkSheet->getStyle('C'.$sectionLineStart.':E'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('specificEnthalpy'));
        $objWorkSheet->getStyle('F'.$sectionLineStart.':H'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('specificEntropy'));        
        $objWorkSheet->getStyle('I'.$sectionLineStart.':K'.$linePointer)->getNumberFormat()->setFormatCode($mS->excelFormat('specificVolume'));
        
        $objWorkSheet->getStyle('A100:A100');
    }
}